<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
  import { getFirestore, doc, setDoc, getDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

  // --- FIREBASE CONFIGURATION ---
  const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
  const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
  const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

  let db = null;
  let auth = null;
  let userId = null;
  let isFirebaseReady = false;

  // --- DERIV API CONSTANTS ---
  const API_APP_ID = 1089;
  const SYMBOL = 'R_25';
  const API_URL = `wss://ws.binaryws.com/websockets/v3?app_id=${API_APP_ID}`;

  // --- SCALP MOMENTUM DEFAULTS (works even while your UI is locked) ---
  const SCALP_CONFIG = {
    duration: 5,
    durationUnit: "t",          // ticks
    tickBufferSize: 8,
    minTicksToEvaluate: 6,
    moveTrigger: 0.02,          // momentum threshold
    tpUSD: 0.05,                // auto close profit
    slUSD: 0.05,                // auto close loss
    cooldownAfterTradeSec: 2     // extra small cooldown after any close
  };

  // --- BALANCE TIER CONFIGURATION ---
  const TIER_CONFIGS = {
    BLOCKED: {
      min: 0.00, max: 0.89, name: "BLOCKED (Min $0.90)",
      maxTradesPerSignal: 0, cooldownDuration: 0,
      maxLossStreak: 999, dailyLossCapPercent: 100.0,
      breakEvenLockUSD: 999, partialLockUSD: 999, trailingStartPercent: 999,
      trailingExitDrawdown: 1.0, isBlocked: true
    },
    MICRO: {
      min: 0.90, max: 4.99, name: "MICRO MODE ($0.90-$4.99)",
      maxTradesPerSignal: 1, cooldownDuration: 300, // 5 min
      maxLossStreak: 1, dailyLossCapPercent: 3.0,
      breakEvenLockUSD: 0.10, partialLockUSD: 0.20, trailingStartPercent: 30.0,
      trailingExitDrawdown: 0.6, isBlocked: false
    },
    LOW: {
      min: 5.00, max: 9.99, name: "LOW MODE ($5-$9.99)",
      maxTradesPerSignal: 2, cooldownDuration: 180, // 3 min
      maxLossStreak: 2, dailyLossCapPercent: 4.0,
      breakEvenLockUSD: 0.15, partialLockUSD: 0.30, trailingStartPercent: 50.0,
      trailingExitDrawdown: 0.6, isBlocked: false
    },
    STANDARD: {
      min: 10.00, max: 50.00, name: "STANDARD MODE ($10-$50)",
      maxTradesPerSignal: 2, cooldownDuration: 180, // 3 min
      maxLossStreak: 2, dailyLossCapPercent: 5.0,
      breakEvenLockUSD: 0.20, partialLockUSD: 0.40, trailingStartPercent: 60.0,
      trailingExitDrawdown: 0.6, isBlocked: false
    }
  };

  // --- GLOBAL STATE ---
  let state = {
    ws: null,
    apiToken: '',
    isBotRunning: false,

    // tier + settings
    settingsLocked: true,
    safeMode: true,
    currentTier: TIER_CONFIGS.BLOCKED,

    stakeAmount: 0.01,
    maxTradesPerSignal: 0,
    cooldownDuration: 0,
    maxLossStreak: 999,
    dailyLossCapPercent: 100.0,

    // trade logic
    bias: "",
    breakoutLevel: 0,

    tradeCounter: 0,
    lossStreak: 0,
    cooldown: false,
    cooldownTimer: null,

    // daily P/L
    currentBalance: 0,
    initialDailyBalance: 0,
    dailyProfitLossUSD: 0,
    dailyLossCapTriggered: false,
    lastClosedDay: new Date().getDate(),

    // live contract
    activeContract: null,
    activeContractId: null,

    // guards
    entryInProgress: false,
    closeRequestedForContractId: null,
    lastNoSellableWarnForContractId: null,
    postCloseCooldownUntil: 0,

    // scalp ticks
    tickBuffer: [],

    // request routing
    reqId: 1,
    pending: new Map(),

    // UI fields
    maxProfit: 0,
    lockedProfitLevel: 'None',
    blockReason: 'Awaiting Start',
  };

  // --- PLATFORM PREFERENCE STATE ---
  let selectedPlatform = null;

  // --- DOM ---
  const tokenInput = document.getElementById('api-token');
  const stakeInput = document.getElementById('stake-amount');
  const maxTradesInput = document.getElementById('max-trades-input');
  const balanceMinInput = document.getElementById('balance-min-input');
  const balanceMaxInput = document.getElementById('balance-max-input');
  const autoScaleToggle = document.getElementById('auto-scale-toggle');
  const cooldownInput = document.getElementById('cooldown-input');
  const maxLossStreakInput = document.getElementById('max-loss-streak-input');
  const dailyCapInput = document.getElementById('daily-cap-input');
  const safeModeToggle = document.getElementById('safe-mode-toggle');
  const unlockBtn = document.getElementById('unlock-settings-btn');
  const safeModeIndicator = document.getElementById('safe-mode-indicator');
  const settingsInputs = document.querySelectorAll('#settings-area .ios-input');
  const toggleBtn = document.getElementById('toggle-bot-btn');
  const logOutput = document.getElementById('log-output');

  const statusDisplay = {
    connection: document.getElementById('connection-status'),
    safeMode: document.getElementById('safe-mode-status'),
    active: document.getElementById('trade-active-status'),
    bias: document.getElementById('breakout-level-display'),

    balance: document.getElementById('current-balance-display'),
    trades: document.getElementById('trades-this-signal-display'),
    currentProfit: document.getElementById('current-profit-display'),
    maxProfit: document.getElementById('max-profit-display'),

    lockedProfit: document.getElementById('locked-profit-level-display'),
    tier: document.getElementById('balance-tier-display'),
    cap: document.getElementById('daily-cap-status'),
    block: document.getElementById('block-reason-display'),
  };

  // modal
  const modalOverlay = document.getElementById('modal-overlay');
  const modalTitle = document.getElementById('modal-title');
  const modalMessage = document.getElementById('modal-message');
  const modalInput = document.getElementById('modal-input');
  const modalCancelBtn = document.getElementById('modal-cancel-btn');
  const modalConfirmBtn = document.getElementById('modal-confirm-btn');

  // --- UTILS ---
  function log(message, type = 'system') {
    const timestamp = new Date().toLocaleTimeString('en-US', { hour12: false });
    const el = document.createElement('p');

    let colorClass = 'text-gray-500';
    if (type === 'error') colorClass = 'text-status-error font-semibold';
    else if (type === 'warn') colorClass = 'text-status-warn';
    else if (type === 'trade') colorClass = 'text-status-active font-medium';
    else if (type === 'system') colorClass = 'text-gray-800';

    el.className = colorClass;
    el.textContent = `[${timestamp} | ${type.toUpperCase()}] ${message}`;
    logOutput.appendChild(el);
    logOutput.scrollTop = logOutput.scrollHeight;
  }

  function showConfirmation(title, message, requiresInput = false, requiredText = '') {
    return new Promise(resolve => {
      modalTitle.textContent = title;
      modalMessage.textContent = message;

      modalInput.classList.toggle('hidden', !requiresInput);
      modalInput.value = '';

      modalConfirmBtn.disabled = requiresInput;
      modalConfirmBtn.classList.toggle('opacity-50', requiresInput);
      modalConfirmBtn.classList.toggle('cursor-not-allowed', requiresInput);

      modalOverlay.classList.remove('hidden');
      modalOverlay.classList.add('flex');

      const confirmHandler = () => {
        if (requiresInput && modalInput.value !== requiredText) return;
        cleanup(true);
      };
      const cancelHandler = () => cleanup(false);
      const inputHandler = () => {
        const match = modalInput.value === requiredText;
        modalConfirmBtn.disabled = !match;
        modalConfirmBtn.classList.toggle('opacity-50', !match);
        modalConfirmBtn.classList.toggle('cursor-not-allowed', !match);
      };

      function cleanup(val) {
        modalOverlay.classList.add('hidden');
        modalOverlay.classList.remove('flex');
        modalConfirmBtn.removeEventListener('click', confirmHandler);
        modalCancelBtn.removeEventListener('click', cancelHandler);
        modalInput.removeEventListener('input', inputHandler);
        resolve(val);
      }

      modalConfirmBtn.addEventListener('click', confirmHandler);
      modalCancelBtn.addEventListener('click', cancelHandler);
      if (requiresInput) modalInput.addEventListener('input', inputHandler);
    });
  }

  function nowMs() { return Date.now(); }

  function resetDailyIfNeeded() {
    const d = new Date().getDate();
    if (d !== state.lastClosedDay) {
      state.lastClosedDay = d;
      state.dailyProfitLossUSD = 0;
      state.dailyLossCapTriggered = false;
      state.initialDailyBalance = state.currentBalance || state.initialDailyBalance || 0;
      log("Daily counters reset (new day).", "system");
    }
  }

  function checkDailyCap() {
    if (!state.initialDailyBalance || state.initialDailyBalance <= 0) return false;
    const pct = (Math.abs(state.dailyProfitLossUSD) / state.initialDailyBalance) * 100;
    const hit = pct >= state.dailyLossCapPercent && state.dailyProfitLossUSD < 0;
    state.dailyLossCapTriggered = !!hit;
    return !!hit;
  }

  // --- FIREBASE ---
  async function initializeFirebaseAndAuth() {
    if (!firebaseConfig) {
      log('Firebase config missing. Persistence will not work.', 'error');
      return;
    }

    try {
      const app = initializeApp(firebaseConfig);
      db = getFirestore(app);
      auth = getAuth(app);
      setLogLevel('debug');

      await new Promise(resolve => {
        const unsub = onAuthStateChanged(auth, async (user) => {
          if (user) {
            userId = user.uid;
            isFirebaseReady = true;
            log(`Authenticated. User ID
