<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kut Milz TB</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Lightweight Charts (for the live chart) -->
    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>

    <style>
        /* ABSOLUTE RULE: DO NOT TOUCH OR CHANGE ANY BACKGROUND CODE */
        body {
            font-family: 'Inter', sans-serif;
            background: #0f172a; /* Slate-900 */
            color: #e2e8f0; /* Slate-200 */
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 20px 10px;
        }

        /* Custom scrollbar for dark theme */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }

        .card {
            background: #1e293b; /* Slate-800 */
            border: 1px solid #334155; /* Slate-700 */
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            margin-bottom: 20px;
        }

        .container-wrapper { width: 100%; max-width: 1200px; }

        .pill {
            padding: 4px 10px;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
        }

        .status-pill {
            display: flex;
            align-items: center;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
        }

        /* Chart container (fits your UI style; does not change background) */
        #chart-container {
            width: 100%;
            height: 320px;
            background: #0b1220;
            border: 1px solid #334155;
            border-radius: 12px;
            overflow: hidden;
        }
        @media (min-width: 1024px) {
            #chart-container { height: 360px; }
        }
    </style>
</head>

<body>
<div class="container-wrapper">
    <h1 class="text-3xl font-bold text-center mb-6 text-white">Kut Milz TB</h1>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

        <!-- Column 1 -->
        <div class="lg:col-span-1">
            <!-- Bot Controls -->
            <div class="card">
                <h2 class="text-xl font-semibold mb-4 text-sky-400">Bot Controls</h2>
                <div class="space-y-4">
                    <button id="toggle-bot-btn"
                            class="w-full py-3 rounded-lg font-bold transition duration-200 bg-emerald-600 hover:bg-emerald-700 text-white shadow-lg">
                        START BOT
                    </button>
                </div>

                <div class="mt-6 border-t border-slate-700 pt-4 space-y-3">
                    <h3 class="text-lg font-medium text-slate-300">Live Status</h3>

                    <div class="flex justify-between items-center">
                        <span class="text-sm">Connection:</span>
                        <span id="connection-status" class="status-pill bg-red-800 text-white">DISCONNECTED</span>
                    </div>

                    <div class="flex justify-between items-center">
                        <span class="text-sm">Trade Active:</span>
                        <span id="trade-active-status" class="status-pill bg-slate-600 text-slate-300">Idle</span>
                    </div>

                    <div class="flex justify-between items-center">
                        <span class="text-sm">Current Mode:</span>
                        <span id="mode-status" class="status-pill bg-indigo-800 text-white">SCALP</span>
                    </div>

                    <div class="flex justify-between items-center">
                        <span class="text-sm">H4 Trend:</span>
                        <span id="h4-trend-display" class="status-pill bg-slate-600 text-slate-300">LOADING</span>
                    </div>

                    <div class="flex justify-between items-center">
                        <span class="text-sm">Reason Blocked:</span>
                        <span id="block-reason-display" class="status-pill bg-slate-600 text-slate-300">None</span>
                    </div>
                </div>
            </div>

            <!-- Account Summary -->
            <div class="card">
                <h2 class="text-xl font-semibold mb-4 text-sky-400">Account Summary</h2>

                <div id="account-warning" class="hidden mb-3 p-3 rounded-lg border border-red-700 bg-red-950/40 text-red-200 text-sm">
                    <div class="font-bold text-red-200">⚠️ VOL / VOL 1s NOT AVAILABLE on this connected account</div>
                    <div class="mt-1 text-xs text-red-200">
                        Your API token is connected to an account that doesn’t list Volatility instruments.
                        Use a <b>Synthetic/Derived</b> account (Deriv/DTrader Synthetic or MT5 Derived),
                        not Financial/Standard.
                    </div>
                </div>

                <div class="space-y-3">
                    <div class="flex justify-between items-center border-b border-slate-700 pb-2">
                        <span class="text-sm">Current Balance:</span>
                        <span id="current-balance-display" class="text-lg font-bold text-yellow-400">...</span>
                    </div>

                    <div class="flex justify-between items-center">
                        <span class="text-sm">Session Profit (USD):</span>
                        <span id="current-profit-display" class="text-lg font-bold text-slate-300">0.00</span>
                    </div>

                    <div class="flex justify-between items-center">
                        <span class="text-sm">Contract Sellable:</span>
                        <span id="sellable-display" class="status-pill bg-red-500 text-white">NO</span>
                    </div>

                    <div class="flex justify-between items-center border-t border-slate-700 pt-2">
                        <span class="text-sm">Login ID:</span>
                        <span id="loginid-display" class="text-xs font-mono text-slate-200">...</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm">Type:</span>
                        <span id="accttype-display" class="text-xs text-slate-200">...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Column 2 -->
        <div class="lg:col-span-2">

            <!-- Trading Parameters -->
            <div class="card">
                <h2 class="text-xl font-semibold mb-4 text-sky-400">Trading Parameters</h2>

                <div class="grid grid-cols-2 gap-4">
                    <div class="col-span-2">
                        <label for="symbolSelect" class="block text-sm font-medium mb-1">Symbol (VOL / VOL 1s)</label>
                        <select id="symbolSelect"
                                class="w-full p-2 rounded bg-slate-700 border border-slate-600 text-slate-50 focus:ring-sky-500 focus:border-sky-500">
                            <!-- Fallback list (will be replaced by active_symbols if available) -->
                            <option value="R_10">Volatility 10 Index</option>
                            <option value="R_25">Volatility 25 Index</option>
                            <option value="R_50">Volatility 50 Index</option>
                            <option value="R_75">Volatility 75 Index</option>
                            <option value="R_100" selected>Volatility 100 Index</option>
                            <option value="1HZ10V">Volatility 10 (1s)</option>
                            <option value="1HZ25V">Volatility 25 (1s)</option>
                            <option value="1HZ50V">Volatility 50 (1s)</option>
                            <option value="1HZ75V">Volatility 75 (1s)</option>
                            <option value="1HZ100V">Volatility 100 (1s)</option>
                        </select>
                        <p class="text-[11px] text-slate-400 mt-1">
                            After you connect, the bot loads the official instrument list from your account.
                        </p>
                    </div>

                    <div>
                        <label for="stakeAmount" class="block text-sm font-medium mb-1">Stake Amount (USD)</label>
                        <input type="number" id="stakeAmount" value="1.00" step="0.01"
                               class="w-full p-2 rounded bg-slate-700 border border-slate-600 text-slate-50 focus:ring-sky-500 focus:border-sky-500">
                    </div>

                    <div>
                        <label for="maxTradesPerSignal" class="block text-sm font-medium mb-1">Max Trades/Signal</label>
                        <input type="number" id="maxTradesPerSignal" value="1" step="1"
                               class="w-full p-2 rounded bg-slate-700 border border-slate-600 text-slate-50 focus:ring-sky-500 focus:border-sky-500">
                    </div>

                    <div>
                        <label for="duration" class="block text-sm font-medium mb-1">Duration</label>
                        <input type="number" id="duration" value="5" step="1"
                               class="w-full p-2 rounded bg-slate-700 border border-slate-600 text-slate-50 focus:ring-sky-500 focus:border-sky-500">
                    </div>

                    <div>
                        <label for="durationUnit" class="block text-sm font-medium mb-1">Duration Unit</label>
                        <select id="durationUnit"
                                class="w-full p-2 rounded bg-slate-700 border border-slate-600 text-slate-50 focus:ring-sky-500 focus:border-sky-500">
                            <option value="t">Ticks</option>
                            <option value="s">Seconds</option>
                            <option value="m">Minutes</option>
                            <option value="h">Hours</option>
                        </select>
                    </div>

                    <div>
                        <label for="tpUSD" class="block text-sm font-medium mb-1">Take Profit (USD)</label>
                        <input type="number" id="tpUSD" value="0.34" step="0.01"
                               class="w-full p-2 rounded bg-slate-700 border border-slate-600 text-slate-50 focus:ring-sky-500 focus:border-sky-500">
                    </div>

                    <div>
                        <label for="slUSD" class="block text-sm font-medium mb-1">Stop Loss (USD)</label>
                        <input type="number" id="slUSD" value="10.00" step="0.01"
                               class="w-full p-2 rounded bg-slate-700 border border-slate-600 text-slate-50 focus:ring-sky-500 focus:border-sky-500">
                    </div>

                    <div class="col-span-2">
                        <label for="cooldownDuration" class="block text-sm font-medium mb-1">Cooldown Duration (s)</label>
                        <input type="number" id="cooldownDuration" value="30" step="1"
                               class="w-full p-2 rounded bg-slate-700 border border-slate-600 text-slate-50 focus:ring-sky-500 focus:border-sky-500">
                    </div>
                </div>
            </div>

            <!-- Protected Defaults -->
            <div class="card">
                <div class="flex justify-between items-start mb-4 border-b border-slate-700 pb-3">
                    <h2 class="text-xl font-semibold text-pink-400">Protected Defaults</h2>
                    <button id="unlock-settings-btn"
                            class="text-sm text-pink-400 hover:text-pink-300 font-medium py-1 px-3 rounded-full border border-pink-500 transition duration-150">
                        Unlock
                    </button>
                </div>

                <div class="space-y-4">

                    <!-- Mode -->
                    <div class="flex items-center justify-between p-3 bg-slate-700/50 rounded-lg">
                        <div class="flex flex-col sm:flex-row sm:items-center">
                            <span class="text-sm font-medium text-slate-300 mr-4">Strategy Mode:</span>
                            <span id="mode-pill" class="pill bg-indigo-600 text-white">SCALP</span>
                        </div>
                        <select id="mode-select"
                                class="p-1 rounded bg-slate-600 text-xs border border-slate-500 focus:ring-indigo-500"
                                disabled>
                            <option value="SCALP">SCALP (Fast Tap-Out)</option>
                            <option value="MOMENTUM">MOMENTUM (Trend + Breakout)</option>
                            <option value="H4">H4 MODE (Strict Trend + Breakout)</option>
                        </select>
                    </div>

                    <!-- Safe Mode -->
                    <div class="flex items-center justify-between p-3 bg-slate-700/50 rounded-lg">
                        <div class="flex flex-col sm:flex-row sm:items-center">
                            <span class="text-sm font-medium text-slate-300 mr-4">Safe Mode:</span>
                            <span id="safe-mode-indicator" class="pill bg-red-600 text-white">OFF</span>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="safe-mode-toggle" class="sr-only peer" disabled>
                            <div class="w-11 h-6 bg-slate-500 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-pink-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-pink-600"></div>
                        </label>
                    </div>

                    <div class="text-center text-xs text-slate-500" id="safe-mode-status">
                        Safe Mode is currently DISABLED.
                    </div>

                    <!-- Auto-resume row -->
                    <div class="flex items-center justify-between p-3 bg-slate-700/50 rounded-lg">
                        <div class="flex flex-col sm:flex-row sm:items-center">
                            <span class="text-sm font-medium text-slate-300 mr-4">Auto-resume after cooldown:</span>
                            <span id="autoresume-indicator" class="pill bg-emerald-600 text-white">ON</span>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="autoresume-toggle" class="sr-only peer" disabled checked>
                            <div class="w-11 h-6 bg-slate-500 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-pink-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-pink-600"></div>
                        </label>
                    </div>

                </div>

                <div class="mt-4 pt-3 border-t border-slate-700">
                    <p class="text-xs text-center text-slate-500">Kut Milz TB</p>
                </div>
            </div>

            <!-- Chart Card -->
            <div class="card">
                <div class="flex items-center justify-between mb-3">
                    <h2 class="text-xl font-semibold text-sky-400">Live Chart</h2>
                    <span id="chart-status" class="pill bg-slate-700 text-slate-200">WAITING</span>
                </div>
                <div id="chart-container"></div>
                <p class="text-xs text-slate-400 mt-2">
                    Live <span class="text-sky-300 font-semibold">1-second candles</span> built from Deriv tick stream for
                    <span id="symbolLabel" class="text-sky-300 font-semibold">R_100</span>.
                </p>
            </div>

            <!-- API Login -->
            <div class="card">
                <div class="flex justify-between items-center mb-4 pb-3 border-b border-slate-700">
                    <h2 class="text-xl font-semibold text-sky-400">API Login</h2>
                    <span id="login-status-badge" class="pill bg-red-800 text-white animate-pulse">DISCONNECTED</span>
                </div>

                <div class="relative mb-3">
                    <label for="api-token" class="block text-sm font-medium mb-1 text-slate-300">Deriv API Token</label>
                    <div class="flex items-center rounded-lg bg-slate-700 border border-slate-600 focus-within:ring-2 focus-within:ring-sky-500 transition duration-150">
                        <span class="p-3 text-sky-400">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 5.25a3 3 0 0 1 3 3v2.25m-15.75 6a3 3 0 0 1 3-3h2.25m3.75-10.25v12a3 3 0 0 1-3 3h-2.25a3 3 0 0 1-3-3v-2.25m15.75-6a3 3 0 0 1-3 3h-2.25a3 3 0 0 1-3-3v-2.25m3.75 10.25v-12a3 3 0 0 1 3-3h2.25a3 3 0 0 1 3 3v2.25" />
                            </svg>
                        </span>

                        <input type="password" id="api-token" placeholder="Paste your API token here..."
                               class="flex-1 p-3 bg-transparent border-none text-slate-50 focus:ring-0 focus:outline-none placeholder-slate-400"
                               autocomplete="off">

                        <button id="toggle-visibility-btn" class="p-3 text-slate-400 hover:text-sky-300 transition duration-150"
                                type="button" title="Show Token">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                      d="M3.988 5.82a1.01 1.01 0 0 0-.083.125M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
                            </svg>
                        </button>
                    </div>
                </div>

                <p id="token-error-message" class="text-sm text-red-400 mb-3 hidden flex items-center">
                    API token required to start the bot.
                </p>

                <p class="text-xs text-slate-500">
                    <span class="font-semibold text-sky-300">Permissions:</span> Read + Trade
                </p>

                <p id="edit-hint" class="text-xs text-slate-500 mb-4">
                    Stored securely in your browser (localStorage). Never share it.
                </p>

                <div class="p-3 bg-slate-700 rounded-lg border border-slate-600 flex flex-col sm:flex-row justify-between items-start sm:items-center">
                    <div class="text-xs space-y-1 sm:space-y-0">
                        <p>Symbol: <span id="symbolLabel2" class="font-bold text-sky-300">R_100</span></p>
                        <p class="mt-1">
                            API URL: <code id="api-url-text" class="text-yellow-400 break-all text-[11px] select-all font-mono">wss://ws.binaryws.com/websockets/v3?app_id=1089</code>
                        </p>
                    </div>
                    <button id="copy-api-url-btn"
                            class="mt-2 sm:mt-0 text-xs py-1 px-3 rounded-full bg-slate-600 hover:bg-slate-500 transition duration-150 text-white font-medium"
                            type="button">
                        Copy URL
                    </button>
                </div>
            </div>

            <!-- Insights (Gemini + fallback) -->
            <div class="card">
                <h2 class="text-xl font-semibold mb-4 text-emerald-400">Market Insights ✨</h2>

                <div class="flex flex-col sm:flex-row gap-4 mb-4">
                    <button id="analyze-market-btn" class="flex-1 py-2 rounded-lg font-bold transition duration-200 bg-emerald-700 hover:bg-emerald-800 text-white shadow-lg">
                        Analyze Market Sentiment ✨
                    </button>
                    <button id="assess-risk-btn" class="flex-1 py-2 rounded-lg font-bold transition duration-200 bg-pink-700 hover:bg-pink-800 text-white shadow-lg">
                        Assess Strategy Risk ✨
                    </button>
                </div>

                <div id="gemini-loading-indicator" class="hidden text-center text-sm text-yellow-500 py-4">
                    Generating insight...
                </div>

                <div id="gemini-output" class="p-3 bg-slate-700 rounded-lg text-sm text-slate-100 min-h-[100px] whitespace-pre-wrap">
                    Tap a button above for analysis. (Works even without API key.)
                </div>

                <div id="gemini-sources" class="mt-2 text-xs text-slate-400 space-y-1"></div>
            </div>

        </div>
    </div>
</div>

<script>
/* ===========================
   CONFIG
=========================== */
const API_URL = 'wss://ws.binaryws.com/websockets/v3?app_id=1089';

/* ===========================
   MODE DEFAULTS
=========================== */
const modeDefaults = {
  SCALP: { stake:1.00, duration:5, durationUnit:'t', tp:0.34, sl:10.00, maxTrades:1, cooldown:30, tickBufferSize:6,  momentumThreshold:0.015, useTrendFilter:false, breakoutStrict:false },
  MOMENTUM:{ stake:2.00, duration:1, durationUnit:'m', tp:0.60, sl:15.00, maxTrades:1, cooldown:45, tickBufferSize:10, momentumThreshold:0.030, useTrendFilter:true,  breakoutStrict:false },
  H4:     { stake:2.00, duration:2, durationUnit:'m', tp:0.80, sl:20.00, maxTrades:1, cooldown:60, tickBufferSize:12, momentumThreshold:0.040, useTrendFilter:true,  breakoutStrict:true  }
};

/* ===========================
   GLOBAL STATE
=========================== */
const appState = {
  ws:null, token: localStorage.getItem('derivToken') || '',
  isBotRunning:false, isAuthenticated:false, isEntryInProgress:false,
  tickSubId:null, balanceSubId:null,

  currentBalance:0.00, sessionProfit:0.00,

  tradeCounter:0, currentContractId:null, currentContractBuyPrice:0, currentContractEntryTime:0,
  is_sellable:0, isSelling:false,

  mode:'SCALP', isSettingsLocked:true, isSafeMode:false,

  symbol:'R_100',

  stakeAmount:1.00, duration:5, durationUnit:'t', tpUSD:0.34, slUSD:10.00, maxTradesPerSignal:1, cooldownDuration:30,

  tickBuffer:[], tickBufferSize:6, momentumThreshold:0.015, lastTick:null,

  cooldownUntil:0, autoResume:true,

  pendingProposalId:null, pendingProposalAt:0,

  useTrendFilter:false, breakoutStrict:false,

  trend:{ enabled:true, status:"LOADING", tfSeconds:14400, emaFast:20, emaSlow:50, lastUpdated:0, refreshMs:60000, ema20:null, ema50:null },

  chart:{ initialized:false, lastCandleTime:0, lastOHLC:null, hasTick:false },

  account: { loginid:'', isVirtual:null, currency:'', warningNoVols:false }
};

/* ===========================
   DOM
=========================== */
const dom = {
  symbolSelect: document.getElementById('symbolSelect'),
  symbolLabel: document.getElementById('symbolLabel'),
  symbolLabel2: document.getElementById('symbolLabel2'),

  modeSelect: document.getElementById('mode-select'),
  modePill: document.getElementById('mode-pill'),
  modeStatus: document.getElementById('mode-status'),

  safeModeToggle: document.getElementById('safe-mode-toggle'),
  safeModeIndicator: document.getElementById('safe-mode-indicator'),
  safeModeStatus: document.getElementById('safe-mode-status'),

  unlockSettingsBtn: document.getElementById('unlock-settings-btn'),
  toggleBotBtn: document.getElementById('toggle-bot-btn'),

  apiToken: document.getElementById('api-token'),
  editHint: document.getElementById('edit-hint'),

  connectionStatus: document.getElementById('connection-status'),
  tradeActiveStatus: document.getElementById('trade-active-status'),
  currentBalanceDisplay: document.getElementById('current-balance-display'),
  currentProfitDisplay: document.getElementById('current-profit-display'),
  sellableDisplay: document.getElementById('sellable-display'),
  blockReasonDisplay: document.getElementById('block-reason-display'),

  stakeAmountInput: document.getElementById('stakeAmount'),
  durationInput: document.getElementById('duration'),
  durationUnitInput: document.getElementById('durationUnit'),
  tpUSDInput: document.getElementById('tpUSD'),
  slUSDInput: document.getElementById('slUSD'),
  maxTradesPerSignalInput: document.getElementById('maxTradesPerSignal'),
  cooldownDurationInput: document.getElementById('cooldownDuration'),

  h4TrendDisplay: document.getElementById('h4-trend-display'),
  chartStatus: document.getElementById('chart-status'),

  analyzeMarketBtn: document.getElementById('analyze-market-btn'),
  assessRiskBtn: document.getElementById('assess-risk-btn'),
  geminiOutput: document.getElementById('gemini-output'),
  geminiLoadingIndicator: document.getElementById('gemini-loading-indicator'),
  geminiSources: document.getElementById('gemini-sources'),

  loginStatusBadge: document.getElementById('login-status-badge'),
  toggleVisibilityBtn: document.getElementById('toggle-visibility-btn'),
  tokenErrorMessage: document.getElementById('token-error-message'),
  apiUrlText: document.getElementById('api-url-text'),
  copyApiUrlBtn: document.getElementById('copy-api-url-btn'),

  autoResumeToggle: document.getElementById('autoresume-toggle'),
  autoResumeIndicator: document.getElementById('autoresume-indicator'),

  accountWarning: document.getElementById('account-warning'),
  loginIdDisplay: document.getElementById('loginid-display'),
  acctTypeDisplay: document.getElementById('accttype-display'),
};

/* ===========================
   UI HELPERS
=========================== */
const updateConnectionStatus = (status, color) => {
  dom.connectionStatus.textContent = status;
  dom.connectionStatus.className = `status-pill ${color}`;
};
const updateLoginBadge = (statusText) => {
  const badge = dom.loginStatusBadge;
  if (!badge) return;
  if (statusText === 'CONNECTED') {
    badge.textContent = 'CONNECTED';
    badge.className = 'pill bg-emerald-600 text-white';
  } else if (statusText.includes('DISCONNECTED') || statusText.includes('ERROR') || statusText.includes('Auth Failed')) {
    badge.textContent = 'DISCONNECTED';
    badge.className = 'pill bg-red-800 text-white';
  } else {
    badge.textContent = 'CONNECTING...';
    badge.className = 'pill bg-yellow-600 text-white animate-pulse';
  }
};
const setupConnectionObserver = () => {
  const observer = new MutationObserver(() => updateLoginBadge(dom.connectionStatus.textContent));
  observer.observe(dom.connectionStatus, { childList: true, subtree: true, characterData: true });
};
const updateTradeStatus = (status, color='bg-slate-600 text-slate-300') => {
  dom.tradeActiveStatus.textContent = status;
  dom.tradeActiveStatus.className = `status-pill ${color}`;
};
const updateSellableStatus = (isSellable) => {
  appState.is_sellable = isSellable;
  if (isSellable === 1) {
    dom.sellableDisplay.textContent = 'YES';
    dom.sellableDisplay.className = 'status-pill bg-emerald-600 text-white';
  } else {
    dom.sellableDisplay.textContent = 'NO';
    dom.sellableDisplay.className = 'status-pill bg-red-500 text-white';
  }
};
const updateProfitDisplay = (profit) => {
  dom.currentProfitDisplay.textContent = profit.toFixed(2);
  let color = 'text-slate-300';
  if (profit > 0) color = 'text-emerald-400';
  if (profit < 0) color = 'text-red-400';
  dom.currentProfitDisplay.className = `text-lg font-bold ${color}`;
};

function setIfNotEditing(el, value) {
  if (!el) return;
  if (document.activeElement === el) return;
  el.value = value;
}

function updateSymbolLabels() {
  dom.symbolLabel.textContent = appState.symbol;
  dom.symbolLabel2.textContent = appState.symbol;
}

const updateTrendUI = () => {
  const t = appState.trend.status;
  dom.h4TrendDisplay.textContent = t;
  let cls = 'bg-slate-600 text-slate-300';
  if (t === 'BULL') cls = 'bg-emerald-600 text-white';
  if (t === 'BEAR') cls = 'bg-red-600 text-white';
  if (t === 'NEUTRAL') cls = 'bg-yellow-600 text-white';
  if (t === 'ERROR') cls = 'bg-red-800 text-white';
  dom.h4TrendDisplay.className = `status-pill ${cls}`;
};

const updateAutoResumeUI = () => {
  dom.autoResumeIndicator.textContent = appState.autoResume ? 'ON' : 'OFF';
  dom.autoResumeIndicator.className = `pill ${appState.autoResume ? 'bg-emerald-600' : 'bg-red-600'} text-white`;
  dom.autoResumeToggle.checked = !!appState.autoResume;
};

function showAccountWarning(show) {
  if (!dom.accountWarning) return;
  if (show) dom.accountWarning.classList.remove('hidden');
  else dom.accountWarning.classList.add('hidden');
}

const setSettingsLock = (isLocked) => {
  appState.isSettingsLocked = isLocked;
  const protectedInputs = [ dom.modeSelect, dom.safeModeToggle, dom.autoResumeToggle ];
  protectedInputs.forEach(input => input.disabled = isLocked);

  dom.unlockSettingsBtn.textContent = isLocked ? 'Unlock' : 'Lock';
  dom.unlockSettingsBtn.className = isLocked
    ? 'text-sm text-pink-400 hover:text-pink-300 font-medium py-1 px-3 rounded-full border border-pink-500 transition duration-150'
    : 'text-sm text-white bg-pink-600 hover:bg-pink-700 font-medium py-1 px-3 rounded-full border border-pink-700 transition duration-150';
};

const updateUI = () => {
  dom.modePill.textContent = appState.mode;
  dom.modeStatus.textContent = appState.mode;

  dom.safeModeIndicator.textContent = appState.isSafeMode ? 'ON' : 'OFF';
  dom.safeModeIndicator.className = `pill ${appState.isSafeMode ? 'bg-emerald-600' : 'bg-red-600'} text-white`;
  dom.safeModeStatus.textContent = appState.isSafeMode
    ? 'Safe Mode is currently ENABLED. Stop Loss sell attempts are allowed.'
    : 'Safe Mode is currently DISABLED.';

  setIfNotEditing(dom.stakeAmountInput, appState.stakeAmount.toFixed(2));
  setIfNotEditing(dom.durationInput, String(appState.duration));
  if (document.activeElement !== dom.durationUnitInput) dom.durationUnitInput.value = appState.durationUnit;
  setIfNotEditing(dom.tpUSDInput, appState.tpUSD.toFixed(2));
  setIfNotEditing(dom.slUSDInput, appState.slUSD.toFixed(2));
  setIfNotEditing(dom.maxTradesPerSignalInput, String(appState.maxTradesPerSignal));
  setIfNotEditing(dom.cooldownDurationInput, String(appState.cooldownDuration));

  if (document.activeElement !== dom.modeSelect) dom.modeSelect.value = appState.mode;
  if (document.activeElement !== dom.safeModeToggle) dom.safeModeToggle.checked = appState.isSafeMode;

  if (document.activeElement !== dom.symbolSelect) dom.symbolSelect.value = appState.symbol;
  updateSymbolLabels();

  updateTrendUI();
  updateAutoResumeUI();

  // account labels
  dom.loginIdDisplay.textContent = appState.account.loginid || '...';
  dom.acctTypeDisplay.textContent =
    appState.account.isVirtual == null ? '...' : (appState.account.isVirtual ? 'DEMO (Virtual)' : 'REAL');

  showAccountWarning(!!appState.account.warningNoVols);

  if (appState.isBotRunning) {
    dom.toggleBotBtn.textContent = 'STOP BOT';
    dom.toggleBotBtn.className = 'w-full py-3 rounded-lg font-bold transition duration-200 bg-red-600 hover:bg-red-700 text-white shadow-lg';
  } else {
    dom.toggleBotBtn.textContent = 'START BOT';
    dom.toggleBotBtn.className = 'w-full py-3 rounded-lg font-bold transition duration-200 bg-emerald-600 hover:bg-emerald-700 text-white shadow-lg';
  }
};

/* ===========================
   INPUT -> STATE (instant)
=========================== */
const updateAppStateFromUI = () => {
  appState.symbol = dom.symbolSelect.value;
  appState.stakeAmount = parseFloat(dom.stakeAmountInput.value) || 0;
  appState.duration = parseInt(dom.durationInput.value) || 0;
  appState.durationUnit = dom.durationUnitInput.value;
  appState.tpUSD = parseFloat(dom.tpUSDInput.value) || 0;
  appState.slUSD = parseFloat(dom.slUSDInput.value) || 0;
  appState.maxTradesPerSignal = parseInt(dom.maxTradesPerSignalInput.value) || 0;
  appState.cooldownDuration = parseInt(dom.cooldownDurationInput.value) || 0;
  updateSymbolLabels();
};

document.querySelectorAll('input, select').forEach(input => {
  input.addEventListener('input', updateAppStateFromUI);
  input.addEventListener('change', updateAppStateFromUI);
});

/* ===========================
   MODE LOGIC
=========================== */
const loadDefaults = (mode) => {
  const d = modeDefaults[mode];
  if (!d) return;

  appState.mode = mode;
  appState.stakeAmount = d.stake;
  appState.duration = d.duration;
  appState.durationUnit = d.durationUnit;
  appState.tpUSD = d.tp;
  appState.slUSD = d.sl;
  appState.maxTradesPerSignal = d.maxTrades;
  appState.cooldownDuration = d.cooldown;

  appState.tickBufferSize = d.tickBufferSize;
  appState.momentumThreshold = d.momentumThreshold;

  appState.useTrendFilter = !!d.useTrendFilter;
  appState.breakoutStrict = !!d.breakoutStrict;

  appState.trend.enabled = appState.useTrendFilter;
  updateUI();
};

/* ===========================
   TOKEN VISIBILITY + COPY URL
=========================== */
const toggleTokenVisibility = () => {
  const input = dom.apiToken;
  const isPassword = input.type === 'password';
  input.type = isPassword ? 'text' : 'password';
};
const copyApiUrl = () => {
  const textToCopy = dom.apiUrlText.textContent;
  const textarea = document.createElement('textarea');
  textarea.value = textToCopy;
  textarea.style.position = 'fixed';
  textarea.style.opacity = '0';
  document.body.appendChild(textarea);
  textarea.select();
  try {
    document.execCommand('copy');
    dom.copyApiUrlBtn.textContent = 'Copied!';
  } catch (err) {
    dom.copyApiUrlBtn.textContent = 'Failed!';
  }
  setTimeout(() => dom.copyApiUrlBtn.textContent = 'Copy URL', 2000);
  document.body.removeChild(textarea);
};

/* ===========================
   CHART (1s candles from ticks)
=========================== */
let chart = null;
let candleSeries = null;
let ro = null;

function initChart() {
  const container = document.getElementById('chart-container');
  if (!container) return;

  if (typeof LightweightCharts === "undefined") {
    dom.chartStatus.textContent = "CHART CDN ERROR";
    dom.chartStatus.className = "pill bg-red-700 text-white";
    return;
  }

  if (chart) { try { chart.remove(); } catch (_) {} }

  chart = LightweightCharts.createChart(container, {
    width: container.clientWidth,
    height: container.clientHeight,
    layout: { background: { color: '#0b1220' }, textColor: '#e2e8f0' },
    grid: { vertLines: { color: '#243244' }, horzLines: { color: '#243244' } },
    rightPriceScale: { borderColor: '#334155' },
    timeScale: { borderColor: '#334155', timeVisible: true, secondsVisible: true },
    crosshair: { mode: LightweightCharts.CrosshairMode.Normal },
  });

  candleSeries = chart.addCandlestickSeries({
    priceLineVisible: false,
    lastValueVisible: true,
  });

  dom.chartStatus.textContent = "READY";
  dom.chartStatus.className = "pill bg-emerald-700 text-white";

  if (ro) ro.disconnect();
  ro = new ResizeObserver(() => {
    if (!chart) return;
    chart.applyOptions({ width: container.clientWidth, height: container.clientHeight });
  });
  ro.observe(container);
}

function resetChart() {
  appState.chart.lastCandleTime = 0;
  appState.chart.lastOHLC = null;
  appState.chart.hasTick = false;
  dom.chartStatus.textContent = "WAITING";
  dom.chartStatus.className = "pill bg-slate-700 text-slate-200";
  initChart();
}

function updateCandleFromTick(price) {
  if (!candleSeries) return;

  const nowSec = Math.floor(Date.now() / 1000);
  if (nowSec < appState.chart.lastCandleTime) return;

  if (appState.chart.lastCandleTime === 0) {
    appState.chart.lastCandleTime = nowSec;
    appState.chart.lastOHLC = { time: nowSec, open: price, high: price, low: price, close: price };
    candleSeries.update(appState.chart.lastOHLC);
    return;
  }

  if (nowSec === appState.chart.lastCandleTime) {
    const c = appState.chart.lastOHLC;
    c.high = Math.max(c.high, price);
    c.low  = Math.min(c.low, price);
    c.close = price;
    candleSeries.update(c);
  } else {
    appState.chart.lastCandleTime = nowSec;
    appState.chart.lastOHLC = { time: nowSec, open: price, high: price, low: price, close: price };
    candleSeries.update(appState.chart.lastOHLC);
  }
}

/* ===========================
   TREND FILTER
=========================== */
function calcEMA(values, period) {
  if (!values || values.length < period) return null;
  const k = 2 / (period + 1);
  let ema = values.slice(0, period).reduce((a,b)=>a+b,0) / period;
  for (let i = period; i < values.length; i++) {
    ema = values[i] * k + ema * (1 - k);
  }
  return ema;
}
function trendClassify(emaFast, emaSlow) {
  if (emaFast == null || emaSlow == null) return "NEUTRAL";
  const diff = emaFast - emaSlow;
  const eps = Math.abs(emaSlow) * 0.000001;
  if (diff > eps) return "BULL";
  if (diff < -eps) return "BEAR";
  return "NEUTRAL";
}
function requestH4Candles() {
  if (!appState.ws || !appState.isAuthenticated) return;
  appState.ws.send(JSON.stringify({ candles: appState.symbol, granularity: appState.trend.tfSeconds, count: 80, end: "latest" }));
}
function maybeRefreshTrend() {
  if (!appState.trend.enabled) return;
  const now = Date.now();
  if (now - appState.trend.lastUpdated < appState.trend.refreshMs) return;
  appState.trend.lastUpdated = now;
  requestH4Candles();
}

/* ===========================
   SIGNALS
=========================== */
function getMomentumDirection() {
  if (appState.tickBuffer.length < appState.tickBufferSize) return null;
  const first = appState.tickBuffer[0];
  const last  = appState.tickBuffer[appState.tickBuffer.length - 1];
  const delta = last - first;
  if (Math.abs(delta) < appState.momentumThreshold) return null;
  return delta > 0 ? 'CALL' : 'PUT';
}
function passesBreakoutFilter(direction) {
  if (!appState.breakoutStrict) return true;
  const buf = appState.tickBuffer;
  if (buf.length < appState.tickBufferSize) return false;
  const last = buf[buf.length - 1];
  const hi = Math.max(...buf);
  const lo = Math.min(...buf);
  const span = hi - lo || 1;
  if (direction === 'CALL') return (hi - last) <= (span * 0.15);
  if (direction === 'PUT')  return (last - lo) <= (span * 0.15);
  return false;
}
function trendAllows(direction) {
  if (!appState.trend.enabled) return true;
  if (appState.trend.status === "LOADING") return false;
  if (direction === 'CALL') return appState.trend.status === "BULL";
  if (direction === 'PUT')  return appState.trend.status === "BEAR";
  return false;
}

/* ===========================
   CONNECT HELPERS
=========================== */
function sendSafe(obj) {
  if (!appState.ws || appState.ws.readyState !== 1) return;
  appState.ws.send(JSON.stringify(obj));
}

/* ===========================
   SYMBOL LIST LOADER (ALL VOL + VOL 1s)
=========================== */
function requestActiveSymbols() {
  sendSafe({ active_symbols: "brief" });
}

function isVolLikeSymbol(s) {
  const dn = (s.display_name || "").toLowerCase();
  const mk = (s.market || "").toLowerCase();
  const sm = (s.submarket || "").toLowerCase();
  // catch volatility indexes + 1s naming differences
  return dn.includes("volatility") || mk.includes("synthetic") || sm.includes("synthetic");
}

function populateSymbolDropdown(activeSymbols) {
  const list = Array.isArray(activeSymbols) ? activeSymbols : [];
  const filtered = list.filter(isVolLikeSymbol);

  // prefer explicit "Volatility" in name
  const vols = filtered.filter(s => (s.display_name || "").toLowerCase().includes("volatility"));

  const finalList = vols.length ? vols : filtered;

  if (!finalList.length) {
    appState.account.warningNoVols = true;
    updateUI();
    return;
  }

  appState.account.warningNoVols = false;

  finalList.sort((a,b) => {
    const a1 = (a.display_name || "").includes("(1s") ? 1 : 0;
    const b1 = (b.display_name || "").includes("(1s") ? 1 : 0;
    if (a1 !== b1) return a1 - b1;
    return (a.display_name || "").localeCompare(b.display_name || "");
  });

  const current = appState.symbol;

  dom.symbolSelect.innerHTML = "";
  for (const s of finalList) {
    const opt = document.createElement("option");
    opt.value = s.symbol;
    opt.textContent = s.display_name || s.symbol;
    dom.symbolSelect.appendChild(opt);
  }

  const hasCurrent = [...dom.symbolSelect.options].some(o => o.value === current);
  appState.symbol = hasCurrent ? current : dom.symbolSelect.value;
  updateSymbolLabels();
  updateUI();
}

/* ===========================
   SUBSCRIBE (switching safe)
=========================== */
function subscribeTicksForSymbol() {
  if (appState.tickSubId) sendSafe({ forget: appState.tickSubId });
  appState.tickSubId = null;
  appState.tickBuffer = [];
  appState.lastTick = null;
  resetChart();
  sendSafe({ ticks: appState.symbol, subscribe: 1 });
  if (appState.trend.enabled) {
    appState.trend.lastUpdated = 0;
    requestH4Candles();
  }
}
function subscribeBalance() {
  if (appState.balanceSubId) sendSafe({ forget: appState.balanceSubId });
  appState.balanceSubId = null;
  sendSafe({ balance: 1, subscribe: 1 });
}

/* ===========================
   BOT START/STOP
=========================== */
const startBot = () => {
  if (appState.isBotRunning) return;

  const token = dom.apiToken.value.trim();
  if (!token) {
    updateTradeStatus('ERROR: Enter API Token', 'bg-red-600 text-white');
    return;
  }

  localStorage.setItem('derivToken', token);
  appState.token = token;

  appState.sessionProfit = 0.00;
  appState.tradeCounter = 0;
  appState.currentContractId = null;
  appState.isEntryInProgress = false;
  appState.isSelling = false;
  appState.cooldownUntil = 0;
  appState.tickBuffer = [];
  appState.pendingProposalId = null;
  appState.pendingProposalAt = 0;
  appState.tickSubId = null;
  appState.balanceSubId = null;

  appState.account.warningNoVols = false;
  updateProfitDisplay(0);

  resetChart();

  appState.isBotRunning = true;
  updateUI();
  connectToDeriv();
};

const stopBot = () => {
  if (appState.ws) { try { appState.ws.close(); } catch (_) {} }
  appState.ws = null;

  appState.isBotRunning = false;
  appState.isAuthenticated = false;
  appState.isEntryInProgress = false;
  appState.currentContractId = null;
  appState.isSelling = false;
  appState.tickBuffer = [];
  appState.cooldownUntil = 0;

  updateConnectionStatus('DISCONNECTED', 'bg-red-800 text-white');
  updateTradeStatus('Stopped.', 'bg-slate-600 text-slate-300');
  dom.blockReasonDisplay.textContent = 'None';

  dom.chartStatus.textContent = "WAITING";
  dom.chartStatus.className = "pill bg-slate-700 text-slate-200";
  updateUI();
};

/* ===========================
   DERIV CONNECT
=========================== */
const connectToDeriv = () => {
  appState.ws = new WebSocket(API_URL);
  updateConnectionStatus('CONNECTING...', 'bg-yellow-600 text-white');
  updateLoginBadge('CONNECTING...');

  appState.ws.onopen = () => {
    updateConnectionStatus('CONNECTED', 'bg-sky-600 text-white');
    sendSafe({ authorize: appState.token });
  };

  appState.ws.onmessage = (msg) => {
    let response;
    try { response = JSON.parse(msg.data); }
    catch (e) { console.error("Bad JSON:", msg.data); return; }
    handleResponse(response);
  };

  appState.ws.onclose = () => {
    appState.isAuthenticated = false;
    if (appState.isBotRunning) {
      updateConnectionStatus('RECONNECTING...', 'bg-yellow-600 text-white');
      setTimeout(connectToDeriv, 2500);
    } else {
      updateConnectionStatus('DISCONNECTED', 'bg-red-800 text-white');
    }
  };

  appState.ws.onerror = (error) => {
    console.error('WebSocket Error:', error);
    updateConnectionStatus('ERROR', 'bg-red-600 text-white');
  };
};

function resetEntryPipeline(reason="reset") {
  appState.isEntryInProgress = false;
  appState.pendingProposalId = null;
  appState.pendingProposalAt = 0;
  if (reason) dom.blockReasonDisplay.textContent = reason;
}

const handleResponse = (response) => {
  if (response.error) {
    console.error('API Error:', response.error.message);
    resetEntryPipeline('API Error');
    if (response.error.code === 'AuthorizationRequired') {
      dom.blockReasonDisplay.textContent = 'Auth Failed';
      stopBot();
      return;
    }
    updateTradeStatus('ERROR', 'bg-red-600 text-white');
    return;
  }

  switch (response.msg_type) {
    case 'authorize': {
      appState.isAuthenticated = true;

      // show login + demo/real
      appState.account.loginid = response.authorize.loginid || '';
      appState.account.isVirtual = !!response.authorize.is_virtual;
      appState.account.currency = response.authorize.currency || '';

      appState.currentBalance = Number(response.authorize.balance || 0);
      dom.currentBalanceDisplay.textContent = `${response.authorize.currency} ${appState.currentBalance.toFixed(2)}`;

      // load symbols for THIS account
      requestActiveSymbols();

      // subscribe streams
      subscribeTicksForSymbol();
      subscribeBalance();
      sendSafe({ proposal_open_contract: 1, subscribe: 1 });

      // trend initial
      appState.trend.lastUpdated = 0;
      if (appState.trend.enabled) requestH4Candles();

      updateTradeStatus('Monitoring Ticks...', 'bg-yellow-600 text-white');
      dom.blockReasonDisplay.textContent = 'None';

      dom.chartStatus.textContent = "LIVE";
      dom.chartStatus.className = "pill bg-sky-700 text-white";
      break;
    }

    case 'active_symbols':
      if (response.active_symbols) populateSymbolDropdown(response.active_symbols);
      break;

    case 'balance':
      if (response.balance && response.balance.id) appState.balanceSubId = response.balance.id;
      appState.currentBalance = Number(response.balance.balance || 0);
      dom.currentBalanceDisplay.textContent = `${response.balance.currency} ${appState.currentBalance.toFixed(2)}`;
      break;

    case 'tick': {
      if (response.tick && response.tick.id) appState.tickSubId = response.tick.id;
      if (!appState.isBotRunning) return;

      const price = Number(response.tick.quote);
      if (!Number.isFinite(price)) return;

      if (!appState.chart.hasTick) {
        appState.chart.hasTick = true;
        dom.chartStatus.textContent = "LIVE";
        dom.chartStatus.className = "pill bg-sky-700 text-white";
      }
      updateCandleFromTick(price);

      appState.lastTick = price;
      appState.tickBuffer.push(price);
      while (appState.tickBuffer.length > appState.tickBufferSize) appState.tickBuffer.shift();

      maybeRefreshTrend();
      checkAndEnterTrade();
      break;
    }

    case 'candles': {
      if (!response.candles || !Array.isArray(response.candles)) {
        appState.trend.status = "ERROR";
        updateTrendUI();
        break;
      }
      const closes = response.candles.map(c => parseFloat(c.close)).filter(n => Number.isFinite(n));
      const ema20 = calcEMA(closes, appState.trend.emaFast);
      const ema50 = calcEMA(closes, appState.trend.emaSlow);
      appState.trend.ema20 = ema20;
      appState.trend.ema50 = ema50;
      appState.trend.status = trendClassify(ema20, ema50);
      updateTrendUI();
      break;
    }

    case 'proposal': {
      if (!appState.isEntryInProgress) break;
      if (!response.proposal || !response.proposal.id) {
        resetEntryPipeline('Proposal Missing');
        updateTradeStatus('ERROR', 'bg-red-600 text-white');
        break;
      }
      appState.pendingProposalId = response.proposal.id;
      sendSafe({ buy: appState.pendingProposalId, price: appState.stakeAmount });
      break;
    }

    case 'buy':
      appState.isEntryInProgress = false;
      appState.pendingProposalId = null;
      appState.currentContractId = response.buy.contract_id;
      appState.currentContractBuyPrice = response.buy.buy_price;
      appState.currentContractEntryTime = Date.now();
      appState.tradeCounter++;
      updateTradeStatus('Contract Active', 'bg-indigo-600 text-white');
      break;

    case 'proposal_open_contract': {
      const c = response.proposal_open_contract;
      if (!c) break;

      if (appState.currentContractId && c.contract_id === appState.currentContractId) {
        updateSellableStatus(c.is_sellable);

        if (c.is_sold === 1) {
          const profit = Number(c.sell_price) - Number(c.buy_price);
          appState.sessionProfit += profit;
          updateProfitDisplay(appState.sessionProfit);

          appState.currentContractId = null;
          appState.isSelling = false;
          appState.isEntryInProgress = false;
          appState.tickBuffer = [];
          appState.tradeCounter = 0;

          appState.cooldownUntil = Date.now() + (appState.cooldownDuration * 1000);
          dom.blockReasonDisplay.textContent = 'Cooldown';
          updateTradeStatus('Trade Closed. Cooldown...', 'bg-orange-500 text-white');

          if (appState.autoResume) {
            setTimeout(() => {
              if (!appState.isBotRunning) return;
              if (Date.now() >= appState.cooldownUntil) {
                dom.blockReasonDisplay.textContent = 'None';
                updateTradeStatus('Monitoring Ticks...', 'bg-yellow-600 text-white');
              }
            }, appState.cooldownDuration * 1000);
          }
          break;
        }

        checkProfitAndLoss(c);
      }
      break;
    }
  }

  updateUI();
};

/* ===========================
   ENTRY + TRADE
=========================== */
function checkAndEnterTrade() {
  if (!appState.isBotRunning || !appState.isAuthenticated) return;

  if (Date.now() < appState.cooldownUntil) { dom.blockReasonDisplay.textContent='Cooldown'; return; }
  else if (dom.blockReasonDisplay.textContent === 'Cooldown' && appState.autoResume) dom.blockReasonDisplay.textContent='None';

  if (appState.isEntryInProgress) { dom.blockReasonDisplay.textContent='Entry In Progress'; return; }
  if (appState.currentContractId) { dom.blockReasonDisplay.textContent='Trade Active'; return; }
  if (appState.tradeCounter >= appState.maxTradesPerSignal) { dom.blockReasonDisplay.textContent='Max Trades/Signal Hit'; return; }

  const direction = getMomentumDirection();
  if (!direction) { dom.blockReasonDisplay.textContent='Waiting Good Move'; return; }

  if (!passesBreakoutFilter(direction)) { dom.blockReasonDisplay.textContent='Waiting Breakout'; return; }

  if (appState.trend.enabled) {
    if (appState.trend.status === "LOADING") { dom.blockReasonDisplay.textContent='H4 Trend Loading'; return; }
    if (!trendAllows(direction)) { dom.blockReasonDisplay.textContent=`H4 Trend Blocked (${appState.trend.status})`; return; }
  }

  dom.blockReasonDisplay.textContent='None';
  enterTrade(direction);
}

function enterTrade(direction) {
  if (!appState.ws || !appState.isAuthenticated) return;

  appState.isEntryInProgress = true;
  appState.tickBuffer = [];
  updateTradeStatus(`Creating Proposal (${direction})...`, 'bg-orange-500 text-white');

  sendSafe({
    proposal: 1,
    amount: appState.stakeAmount,
    basis: 'stake',
    contract_type: direction,
    currency: 'USD',
    duration: appState.duration,
    duration_unit: appState.durationUnit,
    symbol: appState.symbol
  });

  setTimeout(() => {
    if (!appState.isBotRunning) return;
    if (appState.currentContractId) return;
    if (appState.isEntryInProgress) {
      resetEntryPipeline('Entry Timeout');
      updateTradeStatus('Monitoring Ticks...', 'bg-yellow-600 text-white');
    }
  }, 10000);
}

/* ===========================
   TP/SL
=========================== */
function checkProfitAndLoss(contract) {
  const currentProfit = Number(contract.profit);

  if (currentProfit >= appState.tpUSD) { sellContract(); return; }

  if (appState.isSafeMode) {
    const lossThreshold = -Math.abs(appState.slUSD);
    if (currentProfit <= lossThreshold) sellContract();
  }
}

function sellContract() {
  if (appState.isSelling || !appState.currentContractId) return;

  if (appState.is_sellable !== 1) {
    dom.blockReasonDisplay.textContent = 'Not Sellable (Waiting)';
    setTimeout(() => {
      if (!appState.currentContractId) return;
      if (appState.isSelling) return;
      if (appState.is_sellable === 1) sellContract();
    }, 350);
    return;
  }

  appState.isSelling = true;
  updateTradeStatus('Selling...', 'bg-red-500 text-white');
  sendSafe({ sell: appState.currentContractId, price: 0 });
}

/* ===========================
   INSIGHTS (fallback)
=========================== */
const GEMINI_API_KEY = "";
const GEMINI_MODEL = 'gemini-2.5-flash-preview-09-2025';

function fallbackInsight(type) {
  const trend = appState.trend.enabled ? appState.trend.status : "OFF (SCALP)";
  const dir = getMomentumDirection() || "NONE";
  const buf = appState.tickBuffer;
  const first = buf.length ? buf[0] : null;
  const last = buf.length ? buf[buf.length - 1] : null;
  const delta = (first != null && last != null) ? (last - first) : 0;

  if (type === "sentiment") {
    return [
      `Fallback Insight (no API key):`,
      `• Symbol: ${appState.symbol}`,
      `• Mode: ${appState.mode}`,
      `• Trend Filter: ${trend}`,
      `• Momentum Direction: ${dir}`,
      `• Momentum Delta: ${delta.toFixed(4)}`,
      `• TP: $${appState.tpUSD.toFixed(2)} | SL: $${appState.slUSD.toFixed(2)} (SL sells only if Safe Mode ON)`
    ].join('\n');
  }

  return [
    `Fallback Risk Check (no API key):`,
    `• Symbol: ${appState.symbol}`,
    `• Stake: $${appState.stakeAmount.toFixed(2)}`,
    `• TP: $${appState.tpUSD.toFixed(2)} | SL: $${appState.slUSD.toFixed(2)}`,
    `• Duration: ${appState.duration}${appState.durationUnit}`,
    `• Cooldown: ${appState.cooldownDuration}s`,
    `• Session P/L: $${appState.sessionProfit.toFixed(2)}`
  ].join('\n');
}

const callGeminiAPI = async (userQuery, systemPrompt) => {
  dom.geminiLoadingIndicator.classList.remove('hidden');
  dom.geminiOutput.textContent = 'Generating insight... Please wait.';
  dom.geminiSources.innerHTML = '';

  try {
    if (!GEMINI_API_KEY) return { text: fallbackInsight(systemPrompt), sources: [] };
    // (optional real call kept out for safety)
    return { text: fallbackInsight(systemPrompt), sources: [] };
  } finally {
    dom.geminiLoadingIndicator.classList.add('hidden');
  }
};

const analyzeMarket = async () => {
  const result = await callGeminiAPI(`Analyze trading sentiment for ${appState.symbol}.`, "sentiment");
  dom.geminiOutput.textContent = result.text;
};
const assessRisk = async () => {
  updateAppStateFromUI();
  const result = await callGeminiAPI(`Analyze risk for ${appState.symbol}.`, "risk");
  dom.geminiOutput.textContent = result.text;
};

/* ===========================
   SYMBOL SWITCH
=========================== */
function onSymbolChange() {
  updateAppStateFromUI();
  updateUI();
  if (appState.isBotRunning && appState.isAuthenticated) {
    updateTradeStatus(`Switching Symbol → ${appState.symbol}`, 'bg-yellow-600 text-white');
    subscribeTicksForSymbol();
    updateTradeStatus('Monitoring Ticks...', 'bg-yellow-600 text-white');
  }
}

/* ===========================
   INIT + EVENTS
=========================== */
document.addEventListener('DOMContentLoaded', () => {
  initChart();
  appState.symbol = dom.symbolSelect.value || 'R_100';
  updateSymbolLabels();

  loadDefaults(appState.mode);
  setSettingsLock(true);

  if (appState.token) {
    dom.apiToken.value = appState.token;
    dom.editHint.textContent = 'Token loaded and saved. Click "START BOT" to connect.';
  }

  setupConnectionObserver();
  updateLoginBadge(dom.connectionStatus.textContent);
  updateUI();
});

dom.unlockSettingsBtn.addEventListener('click', () => setSettingsLock(!appState.isSettingsLocked));
dom.modeSelect.addEventListener('change', (e) => { loadDefaults(e.target.value); updateAppStateFromUI(); });
dom.safeModeToggle.addEventListener('change', (e) => { appState.isSafeMode = e.target.checked; updateUI(); });
dom.autoResumeToggle.addEventListener('change', (e) => { appState.autoResume = !!e.target.checked; updateAutoResumeUI(); });

dom.symbolSelect.addEventListener('change', onSymbolChange);

dom.toggleVisibilityBtn.addEventListener('click', toggleTokenVisibility);
dom.copyApiUrlBtn.addEventListener('click', copyApiUrl);

dom.analyzeMarketBtn.addEventListener('click', analyzeMarket);
dom.assessRiskBtn.addEventListener('click', assessRisk);

dom.toggleBotBtn.addEventListener('click', () => {
  const token = dom.apiToken.value.trim();
  if (!appState.isBotRunning && token === '') dom.tokenErrorMessage.classList.remove('hidden');
  else dom.tokenErrorMessage.classList.add('hidden');
  if (appState.isBotRunning) stopBot();
  else startBot();
});
</script>
</body>
</html>
